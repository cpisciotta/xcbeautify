name: Release

on:
  push:
    tags:
      - "*"

env:
  # TODO: Load from `.swift-version` file
  SWIFT_VERSION: 6.1
  TAG: ${{ github.ref_name }}

jobs:
  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Create release via gh
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ env.TAG }}" --title "${{ env.TAG }}" --generate-notes

  macos:
    name: Release macOS
    runs-on: macos-latest
    needs: create_release
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}
      - name: Build & Package
        run: make package
      - name: Upload Darwin Universal
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mv release/xcbeautify.zip "xcbeautify-${{ env.TAG }}-universal-apple-macosx.zip"
          gh release upload "${{ env.TAG }}" "xcbeautify-${{ env.TAG }}-universal-apple-macosx.zip" --clobber
      - name: Upload Darwin x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mv .build/x86_64-apple-macosx/release/xcbeautify.zip "xcbeautify-${{ env.TAG }}-x86_64-apple-macosx.zip"
          gh release upload "${{ env.TAG }}" "xcbeautify-${{ env.TAG }}-x86_64-apple-macosx.zip" --clobber
      - name: Upload Darwin arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mv .build/arm64-apple-macosx/release/xcbeautify.zip "xcbeautify-${{ env.TAG }}-arm64-apple-macosx.zip"
          gh release upload "${{ env.TAG }}" "xcbeautify-${{ env.TAG }}-arm64-apple-macosx.zip" --clobber

  ubuntu_x86_64:
    name: Release Linux x86_64
    runs-on: ubuntu-22.04
    needs: create_release
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Download Swift ${{ env.SWIFT_VERSION }}
        run: wget https://download.swift.org/swift-${{ env.SWIFT_VERSION }}-release/ubuntu2204/swift-${{ env.SWIFT_VERSION }}-RELEASE/swift-${{ env.SWIFT_VERSION }}-RELEASE-ubuntu22.04.tar.gz
      - name: Extract Swift ${{ env.SWIFT_VERSION }}
        run: tar xzf swift-${{ env.SWIFT_VERSION }}-RELEASE-ubuntu22.04.tar.gz
      - name: Add Swift toolchain to PATH
        run: echo "$GITHUB_WORKSPACE/swift-${{ env.SWIFT_VERSION }}-RELEASE-ubuntu22.04/usr/bin" >> $GITHUB_PATH
      - name: Package Linux x86_64
        run: make package-linux-x86_64
      - name: Upload Linux x86_64 Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mv xcbeautify.tar.xz "xcbeautify-${{ env.TAG }}-x86_64-unknown-linux-gnu.tar.xz"
          gh release upload "${{ env.TAG }}" "xcbeautify-${{ env.TAG }}-x86_64-unknown-linux-gnu.tar.xz" --clobber
